<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day 1: Math Snake Game</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- éŠæˆ²å®¹å™¨ --- */
        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 0px; 
        }

        canvas {
            background-color: #222;
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 95%;
            height: auto;
            aspect-ratio: 1 / 1;
        }

        /* --- Logo (éŠæˆ²ä¸­) --- */
        .ingame-logo {
            position: absolute;
            top: 5px;      
            left: 10px;    
            width: 50px;
            height: auto;
            z-index: 20;
            opacity: 0.9;
            pointer-events: none;
            filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));
        }

        /* --- æš«åœæŒ‰éˆ• --- */
        #pauseBtn {
            position: absolute;
            top: 5px;      
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #pauseBtn:active { transform: scale(0.9); background: #eee; }

        /* --- HUD (è³‡è¨Šåˆ—) --- */
        #hud-container {
            display: flex;
            justify-content: space-between;
            width: 90%;
            margin-top: 55px; 
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.0em;
            align-items: center;
        }

        .level-badge {
            background: #FF9800;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
        }
        
        .timer-badge {
            background: #607D8B;
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            min-width: 50px;
            text-align: center;
        }
        .timer-badge.urgent {
            background: #F44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- è¦†è“‹å±¤ --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f8ff; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
        }
        .hidden { display: none !important; }

        .start-logo {
            max-width: 120px;
            margin-bottom: 10px;
            display: block;
            min-height: 50px;
        }

        .objective-card {
            background: #fff;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 10px 15px;
            margin: 5px 0;
            width: 85%;
            font-size: 0.9em;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .knowledge-card {
            background: #E8F5E9;
            border-left: 5px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            width: 85%;
            font-size: 0.9em;
            text-align: left;
            color: #2E7D32;
            line-height: 1.6;
        }
        .knowledge-card h3 { margin: 0 0 5px 0; font-size: 1.1em; color: #1B5E20; }

        /* --- æŒ‰éˆ• --- */
        .btn-primary {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            box-shadow: 0 4px #2e7d32;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            min-width: 180px;
        }
        .btn-primary:active {
            box-shadow: 0 2px #2e7d32;
            transform: translateY(2px);
        }

        .btn-secondary {
            background-color: #2196F3;
            box-shadow: 0 4px #1976D2;
        }
        .btn-secondary:active {
            box-shadow: 0 2px #1976D2;
        }

        .btn-danger {
            background-color: #FF9800;
            box-shadow: 0 4px #F57C00;
        }
        .btn-danger:active {
            box-shadow: 0 2px #F57C00;
        }

        /* --- è™›æ“¬æ§åˆ¶å™¨ --- */
        #controls-area {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            width: 200px;
            height: 140px;
            user-select: none;
        }

        .d-pad-btn {
            background-color: #ddd;
            border: 2px solid #bbb;
            border-radius: 15px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px #999;
            transition: all 0.1s;
            color: #555;
            touch-action: manipulation;
        }

        .d-pad-btn:active, .d-pad-btn.active {
            background-color: #81C784;
            color: white;
            box-shadow: 0 0 #666;
            transform: translateY(4px);
        }
        .spacer { visibility: hidden; }

        #toast {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1.2em;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            width: 80%;
        }
        #toast.show { opacity: 1; }

        .daily-target-text {
            font-size: 1.5em;
            color: #333;
            margin: 20px 0;
        }
        .big-number {
            font-size: 2em;
            color: #d32f2f;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <img src="logo1.png" alt="Game Logo" class="ingame-logo" onerror="this.style.opacity='0.3'; this.alt='Logo1 Here'">

        <!-- æš«åœæŒ‰éˆ• (é è¨­éš±è—) -->
        <button id="pauseBtn" class="hidden" onclick="pauseGame()">â¸</button>

        <div id="hud-container">
            <div>
                <span class="level-badge" id="levelDisplay">Day 1</span>
                <span id="timerDisplay" class="timer-badge">30s</span>
            </div>
            <div>
                <span>ğŸ¯ç›®æ¨™: <span id="targetScore" style="color:#d32f2f">3</span></span>
                <span>ğŸå·²åƒ: <span id="currentScore" style="color:#2e7d32">0</span></span>
            </div>
        </div>

        <div id="toast">æç¤ºè¨Šæ¯</div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>

        <div id="controls-area">
            <div class="spacer"></div>
            <div class="d-pad-btn" id="btn-up">â¬†ï¸</div>
            <div class="spacer"></div>
            
            <div class="d-pad-btn" id="btn-left">â¬…ï¸</div>
            <div class="d-pad-btn" id="btn-down">â¬‡ï¸</div>
            <div class="d-pad-btn" id="btn-right">â¡ï¸</div>
        </div>
    </div>

    <!-- 1. é–‹å§‹ç•«é¢ (é¦–é ) -->
    <div id="startScreen" class="overlay">
        <img src="logo.png" alt="Studio Logo" class="start-logo" onerror="this.style.border='2px dashed #ccc'; this.alt='Logo Here'">
        
        <h2 style="color: #333; margin: 5px 0;">Math Snake Game</h2>
        
        <div class="knowledge-card">
            <h3>ğŸ é»æ¨£æ•¸è˜‹æœï¼Ÿ</h3>
            <p>
                1. è¦‹åˆ°è˜‹æœï¼Œå€‹å¿ƒå°±æ•¸<strong>ã€Œ1ã€</strong><br>
                2. é£Ÿå¤šå€‹ï¼Œå°±æ•¸<strong>ã€Œ2ã€</strong>...<br>
                3. æ•¸åˆ°ç›®æ¨™æ•¸ç›®ï¼Œå°±<strong>å³åˆ»åœ</strong>ï¼<br>
                (è¦æ•¸å¾—å¥½æº–å…ˆå¾—æ¶ï¼ğŸ’ª)
            </p>
        </div>

        <div class="objective-card">
            <strong>ğŸ“‹ éŠæˆ²è¦å‰‡ï¼š</strong>
            <ul style="padding-left: 20px; margin: 5px 0; color: #444;">
                <li>çœ‹æ¸…æ¯æ—¥ ğŸ¯ <strong>ç›®æ¨™æ•¸é‡</strong></li>
                <li>åƒå¤ å°±ç«‹åˆ»å›å®¶ ğŸ </li>
                <li><strong>Day 3 èµ·å°å¿ƒç‚¸å½ˆ ğŸ’£</strong></li>
            </ul>
        </div>
        
        <button class="btn-primary" onclick="showTutorialGoal()">â–¶ çœ‹ç¤ºç¯„æ•™å­¸</button>
    </div>

    <!-- 1.5 ç¤ºç¯„ç›®æ¨™å½ˆçª— -->
    <div id="tutorialGoalScreen" class="overlay hidden">
        <h2 style="color: #4CAF50">ğŸ‘€ ç¤ºç¯„æ™‚é–“</h2>
        
        <div class="daily-target-text">
            å…ˆçœ‹ AI ç¤ºç¯„ï¼š<br>
            åƒ <span class="big-number" style="color:#4CAF50">2</span> å€‹è˜‹æœ<br>
            ç„¶å¾Œå›å®¶ ğŸ 
        </div>

        <p style="color: #666">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
        
        <button class="btn-primary" onclick="runTutorial()">â–¶ é–‹å§‹æ’­æ”¾</button>
    </div>

    <!-- 2. æ¯æ—¥ç›®æ¨™å½ˆçª— -->
    <div id="dailyGoalScreen" class="overlay hidden">
        <h2 style="color: #2196F3">ğŸ“… <span id="dailyTitle">Day 1</span></h2>
        
        <div class="daily-target-text">
            ä»Šæ—¥å°è›‡è¦åƒ<br>
            <span class="big-number" id="dailyTargetNum">3</span><br>
            å€‹è˜‹æœ ğŸ
        </div>

        <p style="color: #666">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
        
        <button class="btn-primary" onclick="startDayAction()">ğŸš€ å‡ºç™¼ï¼</button>
    </div>

    <!-- 3. çµæŸ/éé—œç•«é¢ -->
    <div id="endScreen" class="overlay hidden">
        <h2 id="endTitle">éŠæˆ²çµæŸ</h2>
        <p id="endMessage" style="font-size: 1.2em; margin: 15px 0; font-weight: bold;"></p>
        
        <div id="btnGroupSuccess" class="hidden">
            <button class="btn-primary" onclick="nextDay()">é€²å…¥ä¸‹ä¸€å¤© â¡</button>
        </div>
        
        <div id="btnGroupFail" class="hidden" style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn-primary btn-danger" onclick="retryDay()">ğŸ’ª å†æ¥å†å²</button>
            <button class="btn-primary btn-secondary" onclick="goHome()">ğŸ  å›åˆ°é¦–é </button>
        </div>
        
        <div id="btnGroupWin" class="hidden">
            <button class="btn-primary" onclick="goHome()">ğŸ† å®Œç¾é€šé—œ (å›é¦–é )</button>
        </div>
    </div>

    <!-- 4. æš«åœç•«é¢ -->
    <div id="pauseScreen" class="overlay hidden">
        <h2 style="color: #2c3e50; font-size: 2em;">â¸ æš«åœ</h2>
        <p style="font-size: 1.2em; color: #666; margin-bottom: 30px;">ä¼‘æ¯ä¸€é™£ï¼Œé£²å•–æ°´å…ˆ...</p>
        
        <div style="display:flex; flex-direction:column; gap:15px;">
            <button class="btn-primary" onclick="resumeGame()">â–¶ ç¹¼çºŒéŠæˆ²</button>
            <button class="btn-primary btn-secondary" onclick="goHome()">ğŸ  å›åˆ°é¦–é </button>
        </div>
    </div>

    <script>
        // --- éŠæˆ²è¨­å®š ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20; 
        const tileCount = 20; 

        // --- é—œå¡è¨­å®š (Days) ---
        const levels = [
            { target: 3, speed: 250, bombs: 0, time: 30 },
            { target: 5, speed: 230, bombs: 0, time: 50 },
            { target: 7, speed: 210, bombs: 1, time: 70 },
            { target: 9, speed: 190, bombs: 3, time: 90 },
            { target: 10, speed: 180, bombs: 5, time: 110 }
        ];

        // --- è®Šæ•¸ ---
        let currentDayIndex = 0;
        let score = 0;
        let snake = [];
        let apple = {x: 15, y: 15};
        let home = {x: -1, y: -1};
        let bombs = [];
        let velocity = {x: 0, y: 0};
        let gameInterval;
        let timerInterval;
        let timeLeft = 0;
        let isDemoMode = false;
        let isTutorialMode = false; 
        let isPaused = false;
        let synth = window.speechSynthesis; 

        // --- éŸ³æ¨‚ç³»çµ± (BGM) ---
        let audioCtx;
        let bgmInterval;
        let noteIndex = 0;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            // é—œéµä¿®æ”¹ï¼šåœ¨æ¯æ¬¡åˆå§‹åŒ–æ™‚æª¢æŸ¥ä¸¦æ¢å¾© AudioContext
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // ç°¡å–®çš„éŸ³æ•ˆåˆæˆå™¨
        function playTone(freq, duration, type = 'square') {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // æå‡éŸ³é‡ï¼šå¾ 0.02 æå‡åˆ° 0.1
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function startBGM() {
            initAudio(); // ç¢ºä¿ AudioContext å·²å•Ÿå‹•
            
            // å¿«æ¨‚çš„æ—‹å¾‹ (Cå¤§èª¿)
            const melody = [
                {f: 262, d: 0.2}, {f: 330, d: 0.2}, {f: 392, d: 0.2}, {f: 523, d: 0.4}, // C E G C
                {f: 392, d: 0.2}, {f: 330, d: 0.2}, {f: 262, d: 0.4}, // G E C
                {f: 294, d: 0.2}, {f: 349, d: 0.2}, {f: 392, d: 0.2}, {f: 440, d: 0.4}, // D F G A
                {f: 392, d: 0.2}, {f: 349, d: 0.2}, {f: 294, d: 0.4}  // G F D
            ];
            
            if(bgmInterval) clearInterval(bgmInterval);
            
            let tick = 0;
            bgmInterval = setInterval(() => {
                if(isPaused) return; 
                
                let note = melody[tick % melody.length];
                playTone(note.f, note.d, 'square');
                tick++;

            }, 250); // æ¯ 250ms æ’­æ”¾ä¸€å€‹éŸ³ç¬¦
        }

        function stopBGM() {
            if(bgmInterval) clearInterval(bgmInterval);
        }

        // --- è¼”åŠ©å·¥å…·ï¼šæ•¸å­—è½‰ä¸­æ–‡ (è§£æ±ºè®€éŸ³å•é¡Œ) ---
        function toChineseNum(num) {
            const map = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
            if (num <= 10) return map[num];
            return num; // è¶…é10æš«æ™‚å›å‚³æ•¸å­—ï¼Œç›®å‰é—œå¡åªæœ‰5å¤©
        }

        // --- æµç¨‹æ§åˆ¶ ---

        // 1. æº–å‚™ç¤ºç¯„
        function showTutorialGoal() {
            initAudio(); // å˜—è©¦åœ¨ç¬¬ä¸€æ¬¡é»æ“Šæ™‚å–šé†’ Audio
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('tutorialGoalScreen').classList.remove('hidden');
            speak("ç¤ºç¯„é–‹å§‹ï¼Œè«‹çœ‹æ¸…æ¥šï¼Œåƒå…©å€‹è˜‹æœå°±å›å®¶ã€‚");
        }

        // 2. é–‹å§‹ç¤ºç¯„
        function runTutorial() {
            startBGM(); // å•Ÿå‹•éŸ³æ¨‚
            document.getElementById('tutorialGoalScreen').classList.add('hidden');
            
            isDemoMode = true;
            isTutorialMode = true;
            
            // ç¤ºç¯„è¨­å®šï¼šç›®æ¨™åƒ 2 å€‹ï¼Œä½ç½®æ‹‰é–‹
            score = 0;
            snake = [{x: 3, y: 5}, {x: 2, y: 5}, {x: 1, y: 5}]; // èµ·é»åœ¨å·¦ä¸Š
            velocity = {x: 1, y: 0};
            apple = {x: 16, y: 5}; // ç¬¬ä¸€å€‹è˜‹æœåœ¨å³ä¸Š (æ‹‰é–‹æ°´å¹³è·é›¢)
            home = {x: 3, y: 15};  // å®¶åœ¨å·¦ä¸‹
            bombs = [];
            
            document.getElementById('levelDisplay').innerText = "ç¤ºç¯„ä¸­";
            document.getElementById('targetScore').innerText = "2"; 
            document.getElementById('timerDisplay').innerText = "--";
            updateScoreDisplay();

            speak("å‡ºç™¼ï¼");

            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 200); 
        }

        // 3. ç¤ºç¯„çµæŸ -> é¡¯ç¤º Day 1 ç›®æ¨™
        function endTutorial() {
            clearInterval(gameInterval);
            isDemoMode = false;
            isTutorialMode = false;
            showDailyGoal();
        }

        // 4. é¡¯ç¤º Day 1 å½ˆçª—
        function showDailyGoal() {
            initAudio(); // ç¢ºä¿æ¯æ¬¡é€²å…¥æ–°é—œå¡å‰éƒ½æª¢æŸ¥ Audio
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('tutorialGoalScreen').classList.add('hidden');
            
            const levelConfig = levels[currentDayIndex];
            const displayDay = currentDayIndex + 1;
            
            document.getElementById('dailyTitle').innerText = `Day ${displayDay}`;
            document.getElementById('dailyTargetNum').innerText = levelConfig.target;
            
            // ä¿®æ­£è®€éŸ³ï¼šä½¿ç”¨ä¸­æ–‡æ•¸å­—ç¢ºä¿è®€å‡ºã€Œç¬¬äºŒæ—¥ã€è€Œä¸æ˜¯ã€Œç¬¬å…©æ—¥ã€
            speak(`ç¬¬ ${toChineseNum(displayDay)} æ—¥ï¼Œä»Šæ—¥ç›®æ¨™ï¼Œåƒ ${levelConfig.target} å€‹è˜‹æœã€‚`);

            document.getElementById('dailyGoalScreen').classList.remove('hidden');
        }

        // 5. æ­£å¼é–‹å§‹ Day 1
        function startDayAction() {
            initAudio(); // å†æ¬¡ç¢ºä¿ Audio
            document.getElementById('dailyGoalScreen').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden'); 
            isDemoMode = false;
            initLevel();
            speak("è¨ˆæ™‚é–‹å§‹ï¼");
        }

        function initLevel() {
            const levelConfig = levels[currentDayIndex];
            snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
            score = 0;
            velocity = {x: 1, y: 0}; 
            timeLeft = levelConfig.time;
            bombs = [];
            isPaused = false;

            document.getElementById('levelDisplay').innerText = `Day ${currentDayIndex + 1}`;
            document.getElementById('targetScore').innerText = levelConfig.target;
            updateScoreDisplay();
            updateTimerDisplay();

            spawnHome(); 
            spawnBombs(levelConfig.bombs);
            spawnApple();

            startIntervals(levelConfig.speed);
        }

        function startIntervals(speed) {
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, speed);

            if (timerInterval) clearInterval(timerInterval);
            if (!isDemoMode) {
                timerInterval = setInterval(tickTimer, 1000);
            }
        }

        // --- æš«åœç³»çµ± ---
        function pauseGame() {
            if (isDemoMode) return; 
            isPaused = true;
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            document.getElementById('pauseScreen').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.add('hidden'); 
        }

        function resumeGame() {
            isPaused = false;
            document.getElementById('pauseScreen').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            
            const levelConfig = levels[currentDayIndex];
            startIntervals(levelConfig.speed);
        }

        // --- è¨ˆæ™‚å™¨ ---
        function tickTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 5) {
                document.getElementById('timerDisplay').classList.add('urgent');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                speak("æ™‚é–“åˆ°äº†ï¼");
                gameOver(false, "â° æ™‚é–“åˆ°äº†ï¼ä¸‹æ¬¡åŠ æ²¹ï¼");
            }
        }

        function updateTimerDisplay() {
            const el = document.getElementById('timerDisplay');
            el.innerText = timeLeft + "s";
            if (timeLeft > 5) el.classList.remove('urgent');
        }

        // --- éŠæˆ²å¾ªç’° ---
        function gameLoop() {
            if (isDemoMode) {
                autoPilot();
            }
            update();
            draw();
        }

        function update() {
            const levelConfig = levels[currentDayIndex];
            const head = {x: snake[0].x + velocity.x, y: snake[0].y + velocity.y};

            // ç©¿ç‰†
            if (head.x < 0) head.x = tileCount - 1;
            if (head.x >= tileCount) head.x = 0;
            if (head.y < 0) head.y = tileCount - 1;
            if (head.y >= tileCount) head.y = 0;

            snake.unshift(head);

            // åƒè˜‹æœ
            if (head.x === apple.x && head.y === apple.y) {
                score++;
                updateScoreDisplay();
                
                // ç¤ºç¯„æ¨¡å¼åˆ¤å®š (åƒ2å€‹)
                if (isTutorialMode) {
                    speakNumber(score);
                    // åƒåˆ°ç¬¬1å€‹å¾Œï¼Œå†ç”Ÿç¬¬äºŒå€‹
                    spawnApple(); 
                } 
                // ä¸€èˆ¬æ¨¡å¼åˆ¤å®š
                else if (score > levelConfig.target) {
                    if (!isDemoMode) {
                        speak("å“å‘€ï¼åƒå¤ªå¤šäº†ï¼");
                        gameOver(false, "ğŸ˜® å“å‘€ï¼åƒå¤ªå¤šäº†ï¼Œä¸‹æ¬¡æ•¸æ¸…æ¥šå–”ï¼");
                    }
                    return; 
                } else {
                    speakNumber(score); 
                    spawnApple();
                }
            } else {
                snake.pop(); 
            }

            // æ’ç‚¸å½ˆ
            if (!isDemoMode && !isTutorialMode) {
                for (let b of bombs) {
                    if (head.x === b.x && head.y === b.y) {
                        speak("å˜­ï¼è¸©åˆ°ç‚¸å½ˆäº†ï¼");
                        gameOver(false, "ğŸ’£ è¸©åˆ°ç‚¸å½ˆäº†ï¼ä¸‹æ¬¡å°å¿ƒçœ‹è·¯ï¼");
                        return;
                    }
                }
            }

            // é€²å±‹
            if (head.x === home.x && head.y === home.y) {
                // ç¤ºç¯„æ¨¡å¼éé—œ (éœ€åƒæ»¿2å€‹)
                if (isTutorialMode) {
                    if (score === 2) {
                        endTutorial();
                        return;
                    } 
                }

                // ä¸€èˆ¬æ¨¡å¼éé—œ
                if (!isTutorialMode) {
                    if (score === levelConfig.target) {
                        if(isDemoMode) {
                            initLevel();
                        } else {
                            levelComplete();
                        }
                    } else {
                        if (!isDemoMode) {
                            snake.shift(); 
                            snake.reverse(); 
                            showToast(`âŒ é‚„ä¸å¤ å–”ï¼å†åƒ ${levelConfig.target - score} å€‹ï¼`);
                            speak("é‚„æ²’åƒé£½å‘¢ï¼Œå†å»åƒå§ï¼");
                        }
                    }
                }
            }
        }

        function draw() {
            // èƒŒæ™¯ (å…¨é»‘)
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è›‡
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = (i === 0) ? '#4CAF50' : '#81C784';
                ctx.fillRect(snake[i].x * gridSize, snake[i].y * gridSize, gridSize - 2, gridSize - 2);
                if (i === 0) { 
                    ctx.fillStyle = 'white';
                    ctx.fillRect((snake[i].x * gridSize) + 4, (snake[i].y * gridSize) + 4, 4, 4);
                    ctx.fillRect((snake[i].x * gridSize) + 12, (snake[i].y * gridSize) + 4, 4, 4);
                }
            }

            drawApple(apple.x, apple.y);

            // ç‚¸å½ˆ
            for (let b of bombs) {
                ctx.font = '18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText("ğŸ’£", (b.x * gridSize) + 10, (b.y * gridSize) + 10);
            }

            // å®¶
            ctx.fillStyle = '#2196F3';
            ctx.fillRect(home.x * gridSize, home.y * gridSize, gridSize - 2, gridSize - 2);
            ctx.font = '16px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("ğŸ ", (home.x * gridSize) + 10, (home.y * gridSize) + 10);
        }

        function drawApple(x, y) {
            const centerX = (x * gridSize) + gridSize/2;
            const centerY = (y * gridSize) + gridSize/2 + 2;
            const radius = gridSize/2 - 2;
            ctx.fillStyle = '#FF5252';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.ellipse(centerX, centerY - radius, 4, 2, Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();
        }

        // --- ç”Ÿæˆé‚è¼¯ ---
        function spawnApple() {
            let valid = false;
            let tempX, tempY;
            // ç¤ºç¯„æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘æ‰‹å‹•æ§åˆ¶ä¸‹ä¸€å€‹è˜‹æœä½ç½®ï¼Œç¢ºä¿è·¯å¾‘ç°¡å–®
            if (isTutorialMode) {
                if (score === 1) {
                    apple.x = 16; apple.y = 15; // ç¬¬äºŒå€‹è˜‹æœåœ¨å³ä¸‹ï¼Œè®“è›‡å¾€ä¸‹èµ°å†å¾€å·¦ï¼Œå½¢æˆ U å­—å½¢
                    return;
                }
            }

            while (!valid) {
                tempX = Math.floor(Math.random() * tileCount);
                tempY = Math.floor(Math.random() * tileCount);
                if (!isOccupied(tempX, tempY, 'apple')) {
                    apple.x = tempX; apple.y = tempY;
                    valid = true;
                }
            }
        }

        function spawnHome() {
            let valid = false;
            while (!valid) {
                home.x = Math.floor(Math.random() * tileCount);
                home.y = Math.floor(Math.random() * tileCount);
                let distOK = (Math.abs(home.x - 10) >= 5 || Math.abs(home.y - 10) >= 5);
                if (distOK && !isOccupied(home.x, home.y, 'home')) valid = true;
            }
        }

        function spawnBombs(count) {
            bombs = [];
            for(let i=0; i<count; i++) {
                let bomb = {};
                let valid = false;
                while (!valid) {
                    bomb.x = Math.floor(Math.random() * tileCount);
                    bomb.y = Math.floor(Math.random() * tileCount);
                    let distOK = (Math.abs(bomb.x - 10) >= 3 || Math.abs(bomb.y - 10) >= 3);
                    if (distOK && !isOccupied(bomb.x, bomb.y)) valid = true;
                }
                bombs.push(bomb);
            }
        }

        function isOccupied(x, y, ignoreType) {
            for(let p of snake) if(p.x === x && p.y === y) return true;
            if(ignoreType !== 'home' && home.x === x && home.y === y) return true;
            for(let b of bombs) if(b.x === x && b.y === y) return true;
            if(ignoreType !== 'apple' && apple.x === x && apple.y === y) return true;
            return false;
        }

        function updateScoreDisplay() {
            document.getElementById('currentScore').innerText = score;
        }

        function speakNumber(num) {
            speak(num.toString());
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK'; 
                utterance.rate = 1.0; 
                synth.speak(utterance);
            }
        }

        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        
        function levelComplete() {
            clearInterval(gameInterval); 
            clearInterval(timerInterval);
            // ä¿®æ”¹ï¼šèªéŸ³æ”¹ç‚ºã€Œå¤ªå¥½äº†ã€
            speak("å¤ªå¥½äº†ï¼éé—œï¼");
            
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.add('hidden'); 
            
            hideAllEndBtnGroups();

            if (currentDayIndex < levels.length - 1) {
                document.getElementById('endTitle').innerText = `ğŸ‰ Day ${currentDayIndex + 1} å®Œæˆï¼`;
                document.getElementById('endTitle').style.color = "#4CAF50";
                document.getElementById('endMessage').innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Œæº–å‚™è¿æ¥æ–°çš„ä¸€å¤©ï¼";
                document.getElementById('btnGroupSuccess').classList.remove('hidden');
            } else {
                document.getElementById('endTitle').innerText = "ğŸ† æ•¸æ•¸å¤§å¸«ï¼";
                document.getElementById('endTitle').style.color = "#FF9800";
                document.getElementById('endMessage').innerText = "æ­å–œä½ ï¼å…¨éƒ¨æ—¥æ•¸æŒ‘æˆ°æˆåŠŸï¼";
                document.getElementById('btnGroupWin').classList.remove('hidden');
            }
        }

        function gameOver(win, msg) {
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            isDemoMode = true; 
            
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.add('hidden'); 
            document.getElementById('endTitle').innerText = "ğŸ’ª å†æ¥å†å²ï¼";
            document.getElementById('endTitle').style.color = "#FF9800";
            document.getElementById('endMessage').innerText = msg;
            
            hideAllEndBtnGroups();
            document.getElementById('btnGroupFail').classList.remove('hidden');
        }

        function hideAllEndBtnGroups() {
            document.getElementById('btnGroupSuccess').classList.add('hidden');
            document.getElementById('btnGroupFail').classList.add('hidden');
            document.getElementById('btnGroupWin').classList.add('hidden');
        }

        function nextDay() {
            currentDayIndex++;
            showDailyGoal(); 
        }

        function retryDay() {
            showDailyGoal();
        }

        function goHome() {
            currentDayIndex = 0;
            score = 0;
            isDemoMode = false; 
            isTutorialMode = false;
            isPaused = false;
            stopBGM(); 
            
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('dailyGoalScreen').classList.add('hidden');
            document.getElementById('pauseScreen').classList.add('hidden'); 
            document.getElementById('pauseBtn').classList.add('hidden'); 
            document.getElementById('tutorialGoalScreen').classList.add('hidden'); 
            
            document.getElementById('startScreen').classList.remove('hidden');
            
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        }

        // --- æ§åˆ¶ ---
        function setDir(x, y) {
            if (velocity.x === 0 && x !== 0) { velocity = {x: x, y: 0}; }
            if (velocity.y === 0 && y !== 0) { velocity = {x: 0, y: y}; }
        }

        document.addEventListener('keydown', (e) => {
            if(isDemoMode && !isTutorialMode) return; 
            if(isDemoMode && isTutorialMode) return;
            if(isPaused) return; 
            if (e.keyCode === 37) setDir(-1, 0);
            if (e.keyCode === 38) setDir(0, -1);
            if (e.keyCode === 39) setDir(1, 0);
            if (e.keyCode === 40) setDir(0, 1);
        });

        const bindBtn = (id, x, y) => {
            const btn = document.getElementById(id);
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if(!isDemoMode && !isPaused) { setDir(x, y); btn.classList.add('active'); }
            }, {passive: false});
            btn.addEventListener('touchend', (e) => { e.preventDefault(); btn.classList.remove('active'); });
            btn.addEventListener('mousedown', () => { if(!isDemoMode && !isPaused) setDir(x, y); });
        };

        bindBtn('btn-up', 0, -1);
        bindBtn('btn-down', 0, 1);
        bindBtn('btn-left', -1, 0);
        bindBtn('btn-right', 1, 0);

        function autoPilot() {
            const head = snake[0];
            const levelConfig = levels[currentDayIndex];
            
            let target = apple;
            
            if (isTutorialMode) {
                // ç¤ºç¯„æ¨¡å¼ï¼šåƒå¤  2 å€‹å°±å›å®¶
                target = (score >= 2) ? home : apple;
            } else {
                target = (score >= levelConfig.target) ? home : apple;
            }

            if (head.x < target.x) velocity = {x: 1, y: 0};
            else if (head.x > target.x) velocity = {x: -1, y: 0};
            else if (head.y < target.y) velocity = {x: 0, y: 1};
            else if (head.y > target.y) velocity = {x: 0, y: -1};
        }

        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

    </script>
</body>
</html>
