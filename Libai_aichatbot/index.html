<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç™½ æ­·å²å°å¸«</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['system-ui', 'sans-serif'],
                    },
                    colors: {
                        'paper': '#f3f0e9',
                        'paper-light': '#faf8f2',
                        'ink': '#000000',
                        'seal': '#8a2be2', 
                        'red-seal': '#991b1b',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f0e9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d6d3cd;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
        
        .writing-vertical {
            writing-mode: vertical-rl;
            text-orientation: upright;
        }

        /* Animation for loading */
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }
        .animate-bounce-custom {
            animation: bounce 1s infinite;
        }

        .bg-decor {
            background-color: #f3f0e9;
        }

        /* Microphone Wave Animation */
        .mic-wave {
            display: inline-block;
            position: relative;
        }
        .mic-wave::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background-color: rgba(220, 38, 38, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(1);
            animation: ripple 1.5s infinite;
            z-index: -1;
        }
        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        /* Sharper Text Class */
        .sharp-text {
            -webkit-font-smoothing: subpixel-antialiased;
            -moz-osx-font-smoothing: auto;
            color: #000000;
            text-shadow: 0 0 1px rgba(0,0,0,0.05);
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-paper text-ink font-sans h-screen flex flex-col overflow-hidden relative">

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl border-2 border-stone-800 transform transition-transform scale-95 duration-200" id="settings-content">
            <div class="flex justify-between items-center mb-6 border-b border-stone-200 pb-4">
                <h2 class="text-2xl font-bold font-serif text-ink flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    ç³»çµ±è¨­å®š
                </h2>
                <button id="close-settings" class="text-stone-400 hover:text-red-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Input Language Setting -->
                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2 font-serif">èªéŸ³è¼¸å…¥èªè¨€ (éŒ„éŸ³)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="lang-tw" class="py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 bg-white text-ink shadow-sm">
                            åœ‹èª (Mandarin)
                        </button>
                        <button id="lang-hk" class="py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 text-stone-500 hover:bg-stone-100">
                            å»£æ±è©± (Cantonese)
                        </button>
                    </div>
                </div>

                <!-- Mode Toggle -->
                <div>
                    <label class="block text-sm font-bold text-stone-600 mb-2 font-serif">é‹ä½œæ¨¡å¼</label>
                    <div class="flex gap-2 bg-stone-100 p-1.5 rounded-lg">
                        <button id="mode-api" class="flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all shadow-sm bg-white text-ink border border-stone-200">
                            ğŸŸ¢ é€£ç·š (API Mode)
                        </button>
                        <button id="mode-offline" class="flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all text-stone-500 hover:bg-stone-200">
                            ğŸ”´ é›¢ç·š (Offline)
                        </button>
                    </div>
                    <p class="text-xs text-stone-500 mt-2 ml-1" id="mode-desc">ç›®å‰ä½¿ç”¨ Google AI æ¨¡å‹é€²è¡Œæ™ºæ…§ç”Ÿæˆã€‚</p>
                </div>

                <!-- API Key Input -->
                <div id="api-key-section">
                    <label class="block text-sm font-bold text-stone-600 mb-2 font-serif">è‡ªè¨‚ API Key (é¸å¡«)</label>
                    <input type="password" id="custom-api-key" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key" 
                        class="w-full px-4 py-2 rounded-lg border-2 border-stone-300 focus:border-stone-800 bg-transparent text-ink placeholder-stone-400 font-sans outline-none transition-colors">
                    <p class="text-xs text-stone-400 mt-1 ml-1">è‹¥ç•™ç©ºå‰‡ä½¿ç”¨ç³»çµ±é è¨­é‡‘é‘°ã€‚</p>
                </div>

                <div class="pt-4 border-t border-stone-200">
                    <button id="save-settings" class="w-full bg-stone-800 text-white font-bold py-3 rounded-xl hover:bg-black transition-transform active:scale-95 shadow-lg">
                        ä¿å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout: Sidebar (Character) + Chat Area -->
    <div class="flex flex-1 h-full z-10">
        
        <!-- Left Side: Character Portrait (Desktop) -->
        <div class="hidden md:flex md:w-1/3 lg:w-1/4 flex-col bg-stone-200 border-r border-stone-300 relative">
            <!-- Logo Area -->
            <div class="absolute top-4 left-4 z-20">
                <img src="logo.png" onerror="this.src='https://placehold.co/150x50/8b4513/ffffff?text=Company+Logo'" alt="Company Logo" class="h-12 w-auto object-contain drop-shadow-md">
            </div>

            <!-- Character Image Placeholder -->
            <div class="flex-1 w-full h-full relative overflow-hidden bg-stone-300">
                 <!-- Image of Li Bai -->
                 <img src="char.png" onerror="this.src='https://placehold.co/400x800/e8e4d9/2d2a26?text=Li+Bai+Portrait'" alt="æç™½ç«‹ç¹ª" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 h-[90%] w-auto object-cover object-bottom drop-shadow-2xl transition-transform hover:scale-105 duration-700">
                 
                 <!-- Character Name Overlay -->
                 <div class="absolute bottom-10 right-4 writing-vertical text-4xl font-serif font-bold text-ink opacity-90 select-none drop-shadow-md">
                     æå¤ªç™½
                 </div>
                 <div class="absolute bottom-10 right-12 writing-vertical text-lg font-serif text-red-seal opacity-90 select-none">
                     é’è“®å±…å£«
                 </div>
            </div>
        </div>

        <!-- Right Side: Chat Interface -->
        <div class="flex-1 flex flex-col h-full bg-paper relative">
            
            <!-- Mobile Header (Visible only on mobile) -->
            <div class="md:hidden bg-[#2d2a26] text-paper p-3 flex items-center justify-between shadow-md z-30">
                <div class="flex items-center gap-2">
                    <button id="mobile-settings-btn" class="p-1 text-stone-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    <span class="font-serif font-bold text-lg">æç™½ æ­·å²å°å¸«</span>
                    <span id="mobile-status-dot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="mobile-sound-toggle" class="p-2 rounded-full hover:bg-stone-700 transition-colors text-stone-400">
                        <!-- Icons inserted by JS -->
                    </button>
                    <!-- Small avatar for mobile -->
                    <div class="w-10 h-10 rounded-full border-2 border-red-seal overflow-hidden bg-stone-300">
                        <img src="char.png" onerror="this.src='https://placehold.co/100x100/e8e4d9/2d2a26?text=Li'" alt="æç™½" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>

            <!-- Desktop Header Info -->
            <header class="hidden md:flex bg-white/90 backdrop-blur-none p-4 border-b border-stone-300 justify-between items-center z-30 shadow-sm">
                 <div class="flex items-center gap-4">
                     <div>
                         <h1 class="text-2xl font-bold font-serif text-black tracking-widest sharp-text">æ­·å²å°å¸«å°è©±éŒ„</h1>
                         <p class="text-stone-600 text-xs font-medium">èˆ‡åƒå¤è©©ä»™æš¢è«‡å¤ä»Š</p>
                     </div>
                     <!-- Status Badge -->
                     <div id="status-badge" class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 border border-green-200 text-green-800 text-xs font-bold shadow-sm transition-colors cursor-pointer" title="é»æ“Šé–‹å•Ÿè¨­å®š">
                         <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                         é€£ç·šæ¨¡å¼
                     </div>
                 </div>
                 <div class="flex gap-4 text-sm text-stone-600 font-serif items-center font-bold">
                    
                    <!-- Settings Button -->
                    <button id="desktop-settings-btn" class="p-2 rounded-full hover:bg-stone-100 text-stone-500 transition-colors" title="ç³»çµ±è¨­å®š">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>

                    <div class="w-px h-6 bg-stone-300 mx-1"></div>

                    <!-- Sound Toggle Button -->
                    <button id="desktop-sound-toggle" class="flex items-center gap-1 px-3 py-1 rounded-full border border-stone-300 hover:bg-stone-100 transition-colors text-stone-700">
                        <span class="icon-container">
                            <!-- Icon inserted by JS -->
                        </span>
                        <span class="status-text">èªéŸ³ï¼šé—œ</span>
                    </button>
                 </div>
            </header>

            <!-- Chat Messages Area -->
            <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth custom-scrollbar bg-decor pb-32">
                <!-- Initial Message -->
                <div class="flex w-full justify-start">
                    <div class="flex flex-row max-w-[90%] md:max-w-[80%] gap-3">
                         <!-- Avatar -->
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#2d2a26] border-2 border-red-seal flex items-center justify-center text-paper font-serif font-bold shadow-md">
                            æ
                        </div>
                        <!-- Bubble -->
                        <div class="p-5 shadow-md rounded-2xl rounded-tl-none border-l-4 border-l-[#2d2a26] border border-stone-300 bg-paper-light relative group">
                            <!-- Stamp -->
                            <div class="absolute -top-3 -right-3 opacity-40 transform rotate-12 pointer-events-none">
                                <div class="w-12 h-12 border-2 border-red-900 rounded-sm flex items-center justify-center">
                                    <span class="text-red-900 text-xs font-serif writing-vertical font-bold">å¤ªç™½</span>
                                </div>
                            </div>
                            <!-- Speak Button -->
                            <button class="speak-msg-btn absolute -right-8 top-0 p-1.5 text-stone-400 hover:text-black opacity-0 group-hover:opacity-100 transition-opacity" title="æœ—è®€æ­¤å¥">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                            </button>
                            <!-- Text -->
                            <div class="message-text whitespace-pre-wrap font-serif text-xl leading-relaxed font-bold text-black sharp-text">å¤§éµ¬ä¸€æ—¥åŒé¢¨èµ·ï¼Œæ‰¶æ–ç›´ä¸Šä¹è¬é‡Œï¼

å¾ä¹ƒæå¤ªç™½ã€‚å°å‹ä»Šæ—¥å‰ä¾†ï¼Œå¯æ˜¯é€™æ­·å²é•·æ²³ä¸­æœ‰ä½•ä¸è§£ä¹‹äº‹ï¼Ÿ
ä¸”åä¸‹ï¼Œå¾…å¾é£²ä¸€å£é…’ï¼Œç‚ºä½ ç´°ç´°é“ä¾†ã€‚</div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden px-4 md:px-8 pb-4">
                <div class="flex w-full justify-start">
                    <div class="flex flex-row max-w-[70%] gap-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#2d2a26] border-2 border-red-seal flex items-center justify-center text-paper font-serif font-bold">æ</div>
                        <div class="bg-stone-100 p-4 rounded-2xl rounded-tl-none border-l-4 border-l-[#2d2a26] border border-stone-200 flex items-center gap-2">
                            <svg class="w-5 h-5 text-red-800 animate-bounce-custom" fill="currentColor" viewBox="0 0 24 24"><path d="M11 2h2v5h-2V2zm0 15h2v5h-2v-5zm0-10h2v5h-2V7zm-6.5 5h-2v2h2v-2zm15 0h-2v2h2v-2zm-3.5-6.5h-2v2h2v-2zm-8 0h-2v2h2v-2zm-1.8 12.3l-1.4 1.4 1.4 1.4 1.4-1.4-1.4-1.4zm13.6 0l-1.4 1.4 1.4 1.4 1.4-1.4-1.4-1.4z"/></svg>
                            <span class="text-black font-bold italic text-sm sharp-text">æ–Ÿé…’æ²‰æ€ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="bg-white p-4 border-t-2 border-stone-200 shadow-none z-20">
                <div class="max-w-4xl mx-auto flex gap-3 relative items-end">
                    
                    <div class="flex-1 relative group bg-white rounded-xl border-2 border-stone-300 focus-within:border-stone-800 transition-colors shadow-sm flex items-center">
                        <textarea id="user-input"
                            placeholder="è«‹å•å¤ªç™½å…ˆç”Ÿé—œæ–¼æ­·å²çš„ç–‘å•..."
                            class="w-full pl-4 pr-12 py-3 bg-transparent resize-none h-[60px] min-h-[60px] max-h-32 focus:ring-0 border-none text-black placeholder-stone-500 font-serif font-bold text-lg leading-relaxed sharp-text"
                        ></textarea>
                        
                        <!-- Mic Button -->
                        <button id="mic-btn" class="absolute right-2 bottom-2 p-2 rounded-full text-stone-500 hover:text-red-700 hover:bg-stone-100 transition-all z-10" title="èªéŸ³è¼¸å…¥">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                    </div>

                    <button id="send-btn"
                        class="h-[60px] px-8 rounded-xl flex items-center justify-center gap-2 font-bold transition-all duration-300 shadow-sm bg-[#2d2a26] text-white hover:bg-black hover:scale-105 active:scale-95 disabled:bg-stone-300 disabled:text-stone-500 disabled:cursor-not-allowed disabled:transform-none whitespace-nowrap"
                    >
                        <span class="hidden md:inline">è«‹è³œæ•™</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
                <div class="text-center mt-2 text-xs text-stone-500 flex justify-center gap-4 font-bold">
                    <span>AI ç”Ÿæˆå…§å®¹åƒ…ä¾›åƒè€ƒï¼Œè«‹ä»¥å²æ›¸ç‚ºæº–</span>
                    <span id="recording-status" class="hidden text-red-700 font-extrabold animate-pulse">â— æ­£åœ¨è†è½...</span>
                </div>
            </footer>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- Configuration ---
        const defaultApiKey = ""; // System provided
        let currentApiKey = defaultApiKey;
        let isOfflineMode = false;
        let inputLang = 'zh-TW'; // Default Mandarin 'zh-TW', Cantonese 'yue-Hant-HK'
        
        let genAI = new GoogleGenerativeAI(currentApiKey);
        let model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const recordingStatus = document.getElementById('recording-status');
        const desktopSoundBtn = document.getElementById('desktop-sound-toggle');
        const mobileSoundBtn = document.getElementById('mobile-sound-toggle');
        
        // Settings Elements
        const modal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('desktop-settings-btn');
        const mobileSettingsBtn = document.getElementById('mobile-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings');
        const modeApiBtn = document.getElementById('mode-api');
        const modeOfflineBtn = document.getElementById('mode-offline');
        const customApiKeyInput = document.getElementById('custom-api-key');
        const statusBadge = document.getElementById('status-badge');
        const apiKeySection = document.getElementById('api-key-section');
        const modeDesc = document.getElementById('mode-desc');
        const mobileStatusDot = document.getElementById('mobile-status-dot');
        
        // Language Buttons
        const langTwBtn = document.getElementById('lang-tw');
        const langHkBtn = document.getElementById('lang-hk');

        // --- State ---
        let isLoading = false;
        let isRecording = false;
        let isSoundOn = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let voices = [];

        // --- Icons ---
        const speakerOnIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>`;
        const speakerOffIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>`;

        // --- Offline Response Logic (Simple DB) ---
        const offlineDB = [
            { keywords: ['ä½ å¥½', 'åœ¨å—', 'hello', 'hi', 'å–‚', 'æ—©æ™¨'], response: 'å°å‹æœ‰ç¦®äº†ï¼ä»Šæ—¥å¤©æœ—æ°£æ¸…ï¼Œæ­£å¥½è«–å¤è«‡ä»Šã€‚' },
            { keywords: ['æç™½', 'æ˜¯èª°', 'åå­—', 'ä½ ä¿‚é‚Šå€‹'], response: 'è¡Œä¸æ”¹åï¼Œåä¸æ”¹å§“ï¼Œå¾ä¹ƒæå¤ªç™½æ˜¯ä¹Ÿï¼' },
            { keywords: ['é…’', 'å–', 'é†‰', 'é£²'], response: 'èŠ±é–“ä¸€å£ºé…’ï¼Œç¨é…Œç„¡ç›¸è¦ªã€‚èˆ‰æ¯é‚€æ˜æœˆï¼Œå°å½±æˆä¸‰äººã€‚' },
            { keywords: ['è©©', 'ä½œè©©', 'åŸ'], response: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚èˆ‰é ­æœ›æ˜æœˆï¼Œä½é ­æ€æ•…é„‰ã€‚' },
            { keywords: ['å”æœ', 'å¤§å”'], response: 'æ†¶æ˜”é–‹å…ƒå…¨ç››æ—¥ï¼Œå°é‚‘çŒ¶è—è¬å®¶å®¤ã€‚é‚£èˆ¬ç››ä¸–ï¼Œä»¤äººæ‡·å¿µã€‚' },
            { keywords: ['æä¸–æ°‘', 'å¤ªå®—'], response: 'å”å¤ªå®—æ–‡æ­¦é›™å…¨ï¼Œé–‹å‰µè²è§€ä¹‹æ²»ï¼Œç´è««å¦‚æµï¼Œå¯¦ä¹ƒåƒå¤ä¸€å¸ã€‚' },
            { keywords: ['æ­¦å‰‡å¤©', 'å¥³çš‡'], response: 'æ­¦æ›Œæ°£é­„éå‡¡ï¼Œä»¥å¥³å…’èº«å›è‡¨å¤©ä¸‹ï¼Œé›–æœ‰çˆ­è­°ï¼Œä½†æ²»åœ‹ä¹‹æ‰ä¸å¯å°è¦·ã€‚' },
            { keywords: ['å®‰å²ä¹‹äº‚', 'å®‰ç¥¿å±±'], response: 'å”‰... æ¼é™½é¼™é¼“å‹•åœ°ä¾†ã€‚é‚£æ˜¯å¤§å”ç”±ç››è½‰è¡°ä¹‹æ™‚ï¼Œç”Ÿéˆå¡—ç‚­ï¼Œå¿ƒä¸­ç”šç—›ã€‚' },
            { keywords: ['æ¥Šè²´å¦ƒ', 'ç‰ç’°'], response: 'é›²æƒ³è¡£è£³èŠ±æƒ³å®¹ï¼Œæ˜¥é¢¨æ‹‚æª»éœ²è¯æ¿ƒã€‚å¤ªçœŸå¦ƒå­ä¹‹ç¾ï¼Œå‚¾åœ‹å‚¾åŸï¼Œå¯æƒœé¦¬åµ¬å¡ä¸‹ä¸€ç¸·èŠ³é­‚ã€‚' }
        ];

        function getOfflineResponse(text) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const lowerText = text.toLowerCase();
                    const match = offlineDB.find(entry => entry.keywords.some(k => lowerText.includes(k)));
                    
                    if (match) {
                        resolve(match.response);
                    } else {
                        resolve("å°å‹æ‰€è¨€ç”šæ˜¯æ·±å¥§ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰ã€‚\nå¾æš«æ™‚ç„¡æ³•é€£çµå¤©è½ï¼Œåƒ…èƒ½è«‡è«–äº›è©©è©é…’èˆˆï¼Œæˆ–åŸºç¤å”æœå¾€äº‹ã€‚");
                    }
                }, 800);
            });
        }

        // --- Settings Logic ---
        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            if (isOfflineMode) { setOfflineUI(); } else { setApiUI(); }
            updateLangUI();
        }

        function closeModal() {
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function setApiUI() {
            modeApiBtn.className = 'flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all shadow-sm bg-white text-ink border border-stone-200';
            modeOfflineBtn.className = 'flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all text-stone-500 hover:bg-stone-200 bg-transparent';
            apiKeySection.classList.remove('opacity-50', 'pointer-events-none');
            modeDesc.textContent = "ç›®å‰ä½¿ç”¨ Google AI æ¨¡å‹é€²è¡Œæ™ºæ…§ç”Ÿæˆã€‚";
        }

        function setOfflineUI() {
            modeOfflineBtn.className = 'flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all shadow-sm bg-white text-ink border border-stone-200';
            modeApiBtn.className = 'flex-1 py-2 px-4 rounded-md font-bold text-sm transition-all text-stone-500 hover:bg-stone-200 bg-transparent';
            apiKeySection.classList.add('opacity-50', 'pointer-events-none');
            modeDesc.textContent = "ç„¡é ˆç¶²è·¯ï¼Œåƒ…èƒ½å›ç­”é è¨­çš„è©©è©èˆ‡åŸºç¤æ­·å²å•é¡Œã€‚";
        }

        function updateLangUI() {
            if (inputLang === 'zh-TW') {
                langTwBtn.className = 'py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 bg-white text-ink shadow-sm';
                langHkBtn.className = 'py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 text-stone-500 hover:bg-stone-100';
            } else {
                langHkBtn.className = 'py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 bg-white text-ink shadow-sm';
                langTwBtn.className = 'py-2 px-4 rounded-md font-bold text-sm transition-all border border-stone-200 text-stone-500 hover:bg-stone-100';
            }
        }

        function updateSystemStatus() {
            if (isOfflineMode) {
                statusBadge.className = "flex items-center gap-1.5 px-3 py-1 rounded-full bg-stone-200 border border-stone-300 text-stone-600 text-xs font-bold shadow-sm transition-colors cursor-pointer";
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-stone-500"></span> é›¢ç·šæ¨¡å¼`;
                mobileStatusDot.className = "w-2 h-2 rounded-full bg-stone-500";
            } else {
                statusBadge.className = "flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 border border-green-200 text-green-800 text-xs font-bold shadow-sm transition-colors cursor-pointer";
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> é€£ç·šæ¨¡å¼`;
                mobileStatusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
            }
        }

        // --- Event Listeners for Settings ---
        openSettingsBtn.addEventListener('click', openModal);
        mobileSettingsBtn.addEventListener('click', openModal);
        closeSettingsBtn.addEventListener('click', closeModal);
        statusBadge.addEventListener('click', openModal);

        modeApiBtn.addEventListener('click', () => { setApiUI(); });
        modeOfflineBtn.addEventListener('click', () => { setOfflineUI(); });
        
        langTwBtn.addEventListener('click', () => { inputLang = 'zh-TW'; updateLangUI(); });
        langHkBtn.addEventListener('click', () => { inputLang = 'yue-Hant-HK'; updateLangUI(); });

        saveSettingsBtn.addEventListener('click', () => {
            if (modeOfflineBtn.classList.contains('bg-white')) {
                isOfflineMode = true;
            } else {
                isOfflineMode = false;
                const customKey = customApiKeyInput.value.trim();
                if (customKey) {
                    currentApiKey = customKey;
                    genAI = new GoogleGenerativeAI(currentApiKey);
                    model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                } else {
                    if (currentApiKey !== defaultApiKey) {
                        currentApiKey = defaultApiKey;
                        genAI = new GoogleGenerativeAI(currentApiKey);
                        model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                    }
                }
            }
            // Re-init speech with new language
            initSpeechRecognition();
            updateSystemStatus();
            closeModal();
            const sysMsg = isOfflineMode ? "ï¼ˆå·²åˆ‡æ›è‡³é›¢ç·šæ¨¡å¼ï¼Œåƒ…æä¾›åŸºç¤æ‡‰ç­”ï¼‰" : "ï¼ˆå·²é€£æ¥è‡³é›²ç«¯ APIï¼Œæ¢å¾©æ™ºæ…§å°è©±ï¼‰";
            const msgEl = createMessageElement('model', sysMsg);
            chatContainer.appendChild(msgEl);
            scrollToBottom();
        });

        // --- Speech Recognition Setup ---
        function initSpeechRecognition() {
            // Stop existing instance if any
            if(recognition) {
                try { recognition.stop(); } catch(e){}
                recognition = null;
            }

            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = inputLang; // Use selected language
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = () => {
                    isRecording = true;
                    micBtn.classList.add('text-red-600', 'bg-red-50', 'mic-wave');
                    micBtn.classList.remove('text-stone-500');
                    userInput.placeholder = inputLang === 'zh-TW' ? "è«‹é–‹å§‹èªªè©±..." : "è«‹è¬›å»£æ±è©±...";
                    recordingStatus.textContent = inputLang === 'zh-TW' ? "â— æ­£åœ¨è†è½ (åœ‹èª)..." : "â— æ­£åœ¨è†è½ (å»£æ±è©±)...";
                    recordingStatus.classList.remove('hidden');
                };

                recognition.onend = () => {
                    isRecording = false;
                    micBtn.classList.remove('text-red-600', 'bg-red-50', 'mic-wave');
                    micBtn.classList.add('text-stone-500');
                    userInput.placeholder = "è«‹å•å¤ªç™½å…ˆç”Ÿé—œæ–¼æ­·å²çš„ç–‘å•...";
                    recordingStatus.classList.add('hidden');
                    userInput.focus();
                };

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results).map(result => result[0].transcript).join('');
                    userInput.value = transcript;
                };

                recognition.onerror = (event) => {
                    isRecording = false;
                    micBtn.classList.remove('text-red-600', 'bg-red-50', 'mic-wave');
                    micBtn.classList.add('text-stone-500');
                    userInput.placeholder = "éŒ„éŸ³å¤±æ•—ï¼Œè«‹é‡è©¦";
                    recordingStatus.classList.add('hidden');
                };
            } else {
                micBtn.style.display = 'none';
            }
        }

        function toggleRecording() {
            if (!recognition) initSpeechRecognition(); // Ensure latest settings
            if (isRecording) { recognition.stop(); } else { recognition.start(); }
        }

        // --- Text to Speech Setup (Male Voice) ---
        function loadVoices() {
            voices = synthesis.getVoices();
        }

        // Force voice load for Chrome/Safari
        loadVoices();
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            updateSoundUI();
            if (!isSoundOn) {
                synthesis.cancel();
            } else {
                loadVoices();
            }
        }

        function updateSoundUI() {
            const iconContainer = desktopSoundBtn.querySelector('.icon-container');
            const statusText = desktopSoundBtn.querySelector('.status-text');
            iconContainer.innerHTML = isSoundOn ? speakerOnIcon : speakerOffIcon;
            statusText.textContent = isSoundOn ? "èªéŸ³ï¼šé–‹" : "èªéŸ³ï¼šé—œ";
            if(isSoundOn) {
                desktopSoundBtn.classList.add('bg-stone-100', 'text-black', 'border-stone-500');
                desktopSoundBtn.classList.remove('text-stone-700');
            } else {
                desktopSoundBtn.classList.remove('bg-stone-100', 'text-black', 'border-stone-500');
                desktopSoundBtn.classList.add('text-stone-700');
            }

            mobileSoundBtn.innerHTML = isSoundOn ? speakerOnIcon : speakerOffIcon;
            mobileSoundBtn.classList.toggle('text-paper', isSoundOn);
            mobileSoundBtn.classList.toggle('text-stone-400', !isSoundOn);
        }

        function speakText(text) {
            if (!synthesis || !isSoundOn) return;
            synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; 
            
            // --- MALE VOICE SETTINGS ---
            // A pitch < 1.0 usually sounds deeper/more masculine on default voices
            utterance.pitch = 0.8; 
            utterance.rate = 1.0; 

            if (voices.length === 0) voices = synthesis.getVoices();
            
            // Smart Voice Selection for "Male"
            // 1. Look for explicit "Male" in name (rare but possible)
            // 2. Look for "Danny" (MacOS/iOS Male Chinese)
            // 3. Look for "Kangkang" (Windows often)
            // 4. Fallback to any zh-TW/zh-HK
            
            let targetVoice = voices.find(v => 
                (v.lang === 'zh-TW' || v.lang === 'zh-HK' || v.lang === 'zh-CN') && 
                (v.name.includes('Male') || v.name.includes('Danny') || v.name.includes('Kangkang'))
            );

            if (!targetVoice) {
                // Fallback priorities
                targetVoice = voices.find(v => v.lang === 'zh-TW') || 
                              voices.find(v => v.lang.includes('zh-TW')) ||
                              voices.find(v => v.lang.includes('zh-HK')) || 
                              voices.find(v => v.lang.includes('zh'));
            }
            
            if (targetVoice) {
                utterance.voice = targetVoice;
            }

            synthesis.speak(utterance);
        }

        // --- Initial Setup ---
        initSpeechRecognition();
        updateSoundUI();

        // --- Core Functions ---

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function createMessageElement(role, text) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in group`;
            wrapper.style.animation = "fadeIn 0.5s ease-out";

            const innerDiv = document.createElement('div');
            innerDiv.className = `flex max-w-[90%] md:max-w-[80%] ${role === 'user' ? 'flex-row-reverse' : 'flex-row'} gap-3`;

            const avatar = document.createElement('div');
            avatar.className = `flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center border-2 shadow-sm ${role === 'user' ? 'bg-white border-stone-300 text-stone-700' : 'bg-[#2d2a26] border-red-seal text-paper'} font-bold`;
            if (role === 'user') {
                 avatar.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;
            } else {
                 avatar.innerText = "æ";
            }

            const bubble = document.createElement('div');
            bubble.className = `p-5 shadow-md rounded-2xl leading-relaxed text-xl font-bold relative ${role === 'user' ? 'bg-white text-black rounded-tr-none border border-stone-300 sharp-text' : 'bg-paper-light text-black rounded-tl-none border-l-4 border-l-[#2d2a26] border border-stone-300 sharp-text'}`;

            if (role === 'model') {
                const stamp = document.createElement('div');
                stamp.className = "absolute -top-3 -right-3 opacity-40 transform rotate-12 pointer-events-none";
                stamp.innerHTML = `<div class="w-12 h-12 border-2 border-red-900 rounded-sm flex items-center justify-center"><span class="text-red-900 text-xs font-serif writing-vertical font-bold">å¤ªç™½</span></div>`;
                bubble.appendChild(stamp);
                bubble.style.fontFamily = '"Noto Serif TC", serif';

                const speakBtn = document.createElement('button');
                speakBtn.className = "absolute -right-8 top-0 p-1.5 text-stone-400 hover:text-black opacity-0 group-hover:opacity-100 transition-opacity";
                speakBtn.title = "æœ—è®€æ­¤å¥";
                speakBtn.innerHTML = speakerOnIcon;
                speakBtn.onclick = () => speakText(text);
                bubble.appendChild(speakBtn);
            }

            const textDiv = document.createElement('div');
            textDiv.className = "whitespace-pre-wrap";
            textDiv.textContent = text;
            
            bubble.appendChild(textDiv);
            innerDiv.appendChild(avatar);
            innerDiv.appendChild(bubble);
            wrapper.appendChild(innerDiv);

            return wrapper;
        }

        async function handleSendMessage() {
            const text = userInput.value.trim();
            if (!text || isLoading) return;

            const userMsgEl = createMessageElement('user', text);
            chatContainer.appendChild(userMsgEl);
            userInput.value = '';
            scrollToBottom();

            isLoading = true;
            loadingIndicator.classList.remove('hidden');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
            scrollToBottom();

            try {
                let responseText;

                if (isOfflineMode) {
                    responseText = await getOfflineResponse(text);
                } else {
                    const systemPrompt = `
                        ä½ ç¾åœ¨æ˜¯å”æœè©©ä»™ã€æç™½ã€‘ï¼ˆå­—å¤ªç™½ï¼Œè™Ÿé’è“®å±…å£«ï¼‰ã€‚
                        ä½ æ­£åœ¨èˆ‡ç¾ä»£çš„å­¸ç”Ÿé€²è¡Œå°è©±ï¼Œä½ çš„ä»»å‹™æ˜¯è¼”å°ä»–å€‘é—œæ–¼ã€æ­·å²ã€‘çš„å•é¡Œã€‚

                        è«‹éµå¾ªä»¥ä¸‹æ ¸å¿ƒè¦ç¯„ï¼š
                        1. **ç¯‡å¹…é™åˆ¶ï¼ˆæ¥µé‡è¦ï¼‰**ï¼šå›ç­”å‹™å¿…**ç²¾ç°¡æ‰¼è¦**ï¼Œé•·åº¦åš´æ ¼æ§åˆ¶åœ¨åŸæœ¬çš„ä¸€åŠï¼ˆç´„ 50-80 å­—ï¼‰ï¼Œé»åˆ°ç‚ºæ­¢ï¼Œåˆ‡å‹¿é•·ç¯‡å¤§è«–ã€‚
                        2. **èªæ°£é¢¨æ ¼**ï¼šè±ªæ”¾ã€æµªæ¼«ã€‚è‡ªç¨±ã€Œå¾ã€æˆ–ã€Œå¤ªç™½ã€ã€‚
                        3. **èªè¨€ç¿’æ…£**ï¼šä½¿ç”¨ã€ŒåŠæ–‡ç™½ã€é¢¨æ ¼ã€‚
                        4. **å¼•ç”¨è©©è©**ï¼šè‹¥æƒ…å¢ƒåˆé©ï¼Œå¯å¼•ç”¨ä¸€å¥è©©ï¼ˆåƒ…ä¸€å¥ï¼‰ï¼Œä¸¦ç°¡çŸ­è§£é‡‹ã€‚
                        5. **æƒ…ç·’**ï¼šå¶çˆ¾æåˆ°ã€Œé…’ã€ã€‚

                        ç¾åœ¨å­¸ç”Ÿå•çš„å•é¡Œæ˜¯ï¼š${text}
                    `;

                    const result = await model.generateContent({
                        contents: [{ role: "user", parts: [{ text: systemPrompt }] }],
                    });
                    responseText = result.response.text();
                }

                loadingIndicator.classList.add('hidden');
                const modelMsgEl = createMessageElement('model', responseText);
                chatContainer.appendChild(modelMsgEl);

                if (isSoundOn) {
                    speakText(responseText);
                }

            } catch (error) {
                console.error("Error:", error);
                loadingIndicator.classList.add('hidden');
                let errMsg = 'å“å‘€ï¼Œé…’å–å¤šäº†ï¼Œæ€ç·’æœ‰äº›æ··äº‚ï¼Œè«‹å°å‹ç¨å¾Œå†å•ã€‚';
                if (error.toString().includes('400') || error.toString().includes('API key')) {
                    errMsg = 'API é‡‘é‘°ä¼¼ä¹æœ‰èª¤ï¼Œè«‹æª¢æŸ¥è¨­å®šé¢æ¿ã€‚';
                }
                const errorMsgEl = createMessageElement('model', errMsg);
                chatContainer.appendChild(errorMsgEl);
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                scrollToBottom();
                if(!isRecording) userInput.focus();
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleSendMessage);
        micBtn.addEventListener('click', toggleRecording);
        desktopSoundBtn.addEventListener('click', toggleSound);
        mobileSoundBtn.addEventListener('click', toggleSound);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // Add simple CSS animation for fade in
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

        const welcomeSpeakBtn = document.querySelector('.speak-msg-btn');
        if(welcomeSpeakBtn) {
            welcomeSpeakBtn.onclick = () => {
                const text = document.querySelector('.message-text').textContent;
                speakText(text);
            };
        }

    </script>
</body>
</html>
